# Step 1: Building the Tomcat application using Maven compile container
FROM maven:3.9.6-eclipse-temurin-17 AS build
WORKDIR /app
# Insert environment variables for database connection
ARG HOST
ARG PORT
ARG USERNAME
ARG PASSWORD
ARG PROFILE
# Copy the entire project to the container
COPY . .
# Build the application using Maven using docker-compose arguments provided from GitHub Actions
RUN mvn clean package -P${PROFILE} \
  -DHOST=${HOST} \
  -DPORT=${PORT} \
  -DUSERNAME=${USERNAME} \
  -DPASSWORD=${PASSWORD} \
  -DskipTests




# Step 2: Running Tomcat with the application
FROM tomcat:10.1.26-jdk17
# Remove base applications Tomcat
RUN rm -rf apache-tomcat-10.1.26/webapps/*
# Copy WAR file generated by Maven to Tomcat as ROOT app
COPY --from=build /app/src/core/webapp/src/target/*.war Application/apache-tomcat-10.1.26/webapps/ROOT.war
# Expose Tomcat Port
EXPOSE 8080
# Run Tomcat
CMD ["catalina.sh", "run"]